{% extends "base.html" %}

{% block title %}Tableau de bord - BOAMP{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- Stats Cards -->
    <section class="stats-section">
        <h2><i class="fas fa-chart-bar"></i> Statistiques</h2>
        <div class="stats-grid">
            <div class="stat-card total">
                <div class="stat-icon">
                    <i class="fas fa-file-alt"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ stats.total_notices }}</h3>
                    <p>Notices totales</p>
                </div>
            </div>
            
            <div class="stat-card urgent">
                <div class="stat-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ stats.urgent_deadlines }}</h3>
                    <p>Délais urgents (&lt; 7j)</p>
                </div>
            </div>
            
            <div class="stat-card overdue">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ stats.overdue_deadlines }}</h3>
                    <p>Délais dépassés</p>
                </div>
            </div>
            
            <div class="stat-card dce">
                <div class="stat-icon">
                    <i class="fas fa-link"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ stats.with_dce_link }}</h3>
                    <p>Avec DCE</p>
                </div>
            </div>
            
            <div class="stat-card visite">
                <div class="stat-icon">
                    <i class="fas fa-hard-hat"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ stats.with_visite_obligatoire }}</h3>
                    <p>Visite obligatoire</p>
                </div>
            </div>
            
            <div class="stat-card keywords">
                <div class="stat-icon">
                    <i class="fas fa-tags"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ stats.unique_keywords }}</h3>
                    <p>Mots-clés uniques</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Filters -->
    <section class="filters-section">
        <h2><i class="fas fa-filter"></i> Filtres</h2>
        <form method="get" class="filters-form">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="keyword"><i class="fas fa-search"></i> Mot-clé</label>
                    <input type="text" id="keyword" name="keyword" 
                           value="{{ filters.keyword if filters.keyword else '' }}"
                           placeholder="Rechercher par mot-clé...">
                </div>
                
                <div class="filter-group">
                    <label for="department"><i class="fas fa-map-marker-alt"></i> Département</label>
                    <select id="department" name="department">
                        <option value="">Tous les départements</option>
                        {% for dept in departments %}
                        <option value="{{ dept }}" 
                                {% if filters.department == dept %}selected{% endif %}>
                            {{ dept }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="nature"><i class="fas fa-cube"></i> Nature</label>
                    <select id="nature" name="nature">
                        <option value="">Toutes les natures</option>
                        {% for nat in natures %}
                        <option value="{{ nat }}" 
                                {% if filters.nature == nat %}selected{% endif %}>
                            {{ nat }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="filter-row">
                <div class="filter-group">
                    <label for="visite"><i class="fas fa-hard-hat"></i> Visite obligatoire</label>
                    <select id="visite" name="visite">
                        <option value="">Tous</option>
                        <option value="yes" {% if filters.visite == 'yes' %}selected{% endif %}>Oui</option>
                        <option value="no" {% if filters.visite == 'no' %}selected{% endif %}>Non</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="urgency"><i class="fas fa-clock"></i> Délai</label>
                    <select id="urgency" name="urgency">
                        <option value="">Tous les délais</option>
                        <option value="urgent" {% if filters.urgency == 'urgent' %}selected{% endif %}>Urgent (&lt; 7j)</option>
                        <option value="overdue" {% if filters.urgency == 'overdue' %}selected{% endif %}>Dépassé</option>
                        <option value="upcoming" {% if filters.urgency == 'upcoming' %}selected{% endif %}>À venir</option>
                    </select>
                </div>
                
                <div class="filter-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-filter"></i> Appliquer les filtres
                    </button>
                    <a href="/" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Réinitialiser
                    </a>
                </div>
            </div>
        </form>
    </section>

    <!-- Notices Table -->
    <section class="notices-section">
        <div class="section-header">
            <h2><i class="fas fa-list"></i> Notices ({{ notices|length }})</h2>
            <div class="section-actions">
                <button id="export-btn" class="btn btn-outline">
                    <i class="fas fa-download"></i> Exporter
                </button>
            </div>
        </div>
        
        {% if notices %}
        <div class="notices-grid">
            {% for notice in notices %}
            <div class="notice-card {{ notice.deadline_class }}" id="notice-{{ notice.idweb }}">
                <div class="notice-header">
                    <span class="notice-id">{{ notice.idweb }}</span>
                    <span class="notice-deadline {{ notice.deadline_class }}">
                        <i class="fas fa-calendar-alt"></i> {{ notice.deadline_text }}
                    </span>
                </div>
                
                <div class="notice-body">
                    <div class="notice-title-wrapper">
                        <i class="fas fa-star star-icon" onclick="toggleStar(this)" data-notice-id="{{ notice.idweb }}"></i>
                        <i class="fas fa-trash-alt delete-icon" onclick="deleteNotice('{{ notice.idweb }}')" title="Supprimer cette offre"></i>
                        <h3 class="notice-title">
                            <a href="/notice/{{ notice.idweb }}" class="notice-link">
                                {{ notice.objet[:150] }}{% if notice.objet|length > 150 %}...{% endif %}
                            </a>
                        </h3>
                    </div>
                    
                    <div class="notice-buyer">
                        <i class="fas fa-building"></i> {{ notice.nomacheteur }}
                    </div>
                    
                    <div class="notice-meta">
                        <span class="meta-item">
                            <i class="fas fa-calendar"></i> {{ notice.dateparution }}
                        </span>
                        <span class="meta-item">
                            <i class="fas fa-map-marker-alt"></i> 
                            {% for dept in notice.departments_list[:2] %}
                            <span class="dept-badge">{{ dept }}</span>
                            {% endfor %}
                            {% if notice.departments_list|length > 2 %}
                            <span class="dept-badge">+{{ notice.departments_list|length - 2 }}</span>
                            {% endif %}
                        </span>
                    </div>
                    
                    <div class="notice-keywords">
                        {% for keyword in notice.keywords_list[:3] %}
                        <span class="keyword-badge">{{ keyword }}</span>
                        {% endfor %}
                        {% if notice.keywords_list|length > 3 %}
                        <span class="keyword-badge">+{{ notice.keywords_list|length - 3 }}</span>
                        {% endif %}
                    </div>
                    
                    <div class="notice-footer">
                        <div class="footer-left">
                            {% if notice.lots_list %}
                            <span class="lot-info">
                                <i class="fas fa-layer-group"></i> {{ notice.lots_list|length }} lot(s)
                            </span>
                            {% endif %}
                            
                            {% if notice.visite_obligatoire and notice.visite_obligatoire.lower() == 'yes' %}
                            <span class="visite-badge">
                                <i class="fas fa-hard-hat"></i> Visite obligatoire
                            </span>
                            {% endif %}
                        </div>
                        
                        <div class="footer-right">
                            {% if notice.dce_link and notice.dce_link.lower() != 'none' %}
                            <a href="{{ notice.dce_link }}" target="_blank" class="dce-link" title="Accéder au DCE">
                                <i class="fas fa-external-link-alt"></i> DCE
                            </a>
                            {% endif %}
                            
                            <a href="/notice/{{ notice.idweb }}" class="view-link">
                                <i class="fas fa-eye"></i> Détails
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="no-results">
            <i class="fas fa-inbox fa-3x"></i>
            <h3>Aucune notice trouvée</h3>
            <p>Essayez de modifier vos critères de recherche</p>
        </div>
        {% endif %}
    </section>
</div>

<style>
    .star-icon, .delete-icon {
        font-size: 20px;
        cursor: pointer;
        transition: color 0.3s, transform 0.2s;
        margin-right: 8px;
        vertical-align: middle;
    }
    
    .star-icon {
        color: #ddd;
    }
    
    .delete-icon {
        color: #ff6b6b;
    }
    
    .star-icon:hover, .delete-icon:hover {
        transform: scale(1.1);
    }
    
    .star-icon.active {
        color: gold;
    }
    
    .delete-icon:hover {
        color: #ff3838;
    }
    
    .notice-title-wrapper {
        display: flex;
        align-items: flex-start;
        margin-bottom: 8px;
    }
    
    .notice-title {
        flex: 1;
        margin: 0;
    }
</style>
<script>
    // Get CSRF token from meta tag or create a function to retrieve it
    function getCsrfToken() {
        // Check if there's a meta tag with CSRF token
        const metaToken = document.querySelector('meta[name="csrf-token"]');
        if (metaToken) {
            return metaToken.getAttribute('content');
        }
        return '';
    }
    
    function toggleStar(star) {
        star.classList.toggle('active');
        
        const noticeId = star.getAttribute('data-notice-id');
        const isActive = star.classList.contains('active');
        
        if (isActive) {
            localStorage.setItem(`star_${noticeId}`, 'active');
        } else {
            localStorage.removeItem(`star_${noticeId}`);
        }
    }
    
    function deleteNotice(noticeId) {
        if (confirm('Êtes-vous sûr de vouloir supprimer cette offre ? Cette action est irréversible.')) {
            // Show loading state
            const noticeCard = document.getElementById(`notice-${noticeId}`);
            if (noticeCard) {
                noticeCard.style.opacity = '0.5';
                noticeCard.style.pointerEvents = 'none';
            }
            
            // Send AJAX request to delete the notice
            fetch(`/notice/delete/${noticeId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else if (response.status === 404) {
                    throw new Error('Notice non trouvée');
                } else if (response.status === 500) {
                    throw new Error('Erreur serveur');
                } else {
                    throw new Error('Erreur inconnue');
                }
            })
            .then(data => {
                // Remove the notice card from the page
                if (noticeCard) {
                    noticeCard.remove();
                    // Update the notice count
                    const noticeCount = document.querySelector('.notices-section h2');
                    if (noticeCount) {
                        const currentText = noticeCount.textContent;
                        const countMatch = currentText.match(/\((\d+)\)/);
                        if (countMatch) {
                            const currentCount = parseInt(countMatch[1]);
                            const newCount = currentCount - 1;
                            noticeCount.innerHTML = noticeCount.innerHTML.replace(
                                `(${currentCount})`, 
                                `(${newCount})`
                            );
                        }
                    }
                }
                // Also update the stats cards
                updateStatsAfterDeletion();
                showNotification('Offre supprimée avec succès', 'success');
            })
            .catch(error => {
                console.error('Error:', error);
                if (noticeCard) {
                    noticeCard.style.opacity = '1';
                    noticeCard.style.pointerEvents = 'auto';
                }
                showNotification(`Erreur: ${error.message}`, 'error');
            });
        }
    }
    
    function updateStatsAfterDeletion() {
        // Update stats by fetching new data from API
        fetch('/api/stats')
            .then(response => response.json())
            .then(stats => {
                // Update each stat card
                document.querySelector('.stat-card.total h3').textContent = stats.total_notices;
                document.querySelector('.stat-card.urgent h3').textContent = stats.urgent_deadlines;
                document.querySelector('.stat-card.overdue h3').textContent = stats.overdue_deadlines;
                document.querySelector('.stat-card.dce h3').textContent = stats.with_dce_link;
                document.querySelector('.stat-card.visite h3').textContent = stats.with_visite_obligatoire;
                document.querySelector('.stat-card.keywords h3').textContent = stats.unique_keywords;
            })
            .catch(error => console.error('Error updating stats:', error));
    }
    
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <span>${message}</span>
            <button onclick="this.parentElement.remove()">&times;</button>
        `;
        
        // Add styles
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-width: 300px;
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
        `;
        
        if (type === 'success') {
            notification.style.backgroundColor = '#4CAF50';
        } else if (type === 'error') {
            notification.style.backgroundColor = '#f44336';
        } else {
            notification.style.backgroundColor = '#2196F3';
        }
        
        // Add CSS animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
        
        // Add to page
        document.body.appendChild(notification);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }
    
    // Restaurer l'état des étoiles au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
        const stars = document.querySelectorAll('.star-icon');
        stars.forEach(star => {
            const noticeId = star.getAttribute('data-notice-id');
            if (localStorage.getItem(`star_${noticeId}`) === 'active') {
                star.classList.add('active');
            }
        });
        
        // Add click event for export button
        document.getElementById('export-btn')?.addEventListener('click', function() {
            exportNotices();
        });
    });
    
    function exportNotices() {
        // Get current filters from the form
        const keyword = document.getElementById('keyword')?.value || '';
        const department = document.getElementById('department')?.value || '';
        const nature = document.getElementById('nature')?.value || '';
        const visite = document.getElementById('visite')?.value || '';
        const urgency = document.getElementById('urgency')?.value || '';
        
        // Build query string
        const params = new URLSearchParams();
        if (keyword) params.append('keyword', keyword);
        if (department) params.append('department', department);
        if (nature) params.append('nature', nature);
        if (visite) params.append('visite', visite);
        if (urgency) params.append('urgency', urgency);
        
        // Redirect to export endpoint (you'll need to implement this)
        window.location.href = `/api/export?${params.toString()}`;
    }
</script>
{% endblock %}
